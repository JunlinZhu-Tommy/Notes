## 说一下\$nextTick?

### 解释

将 API 中注册的回调函数延迟到 DOM 更新后执行。

特点：

- 一轮事件循环中多次调用 nextTick 只会向任务队列中添加一个任务
- 回调函数中 this 会自动绑定到调用它的实例上（Vue.nextTick 不会，此时的 this 指向谁？）
- 如果没有提供回调函数，在支持 Promise 的情况下会返回一个 Promise
- 在不支持 Promise 的情况下，会进行优雅降级

下面对这几个关键点一一进行解释：**DOM 更新** 、 **延迟 DOM 更新后执行**、 **多次调用只会向队列中添加一个任务**以及**优雅降级**。

### DOM 更新（异步更新队列）

当状态发生改变后，会通知到组件中对应的的 watcher，而后通过虚拟 DOM 进行对整个组件的 diff，而后更新 DOM。如果在这过程中有很多数据发生改变，那么 watcher 就会接受到对应数量的通知，从而进行多次更新（频繁）。但虚拟 DOM 中会将所有状态修改完毕后，才会一次性的将整个组件的 DOM 进行渲染，并不会多次渲染 DOM。

#### 解决方案

在内部将通知到的 watcher 添加到队列中进行缓存，并进行去重操作，如果出现相同 watcher，则说明后面的数据变更是新的，覆盖旧 watcher 即可。

只有队列中不存在这个 watcher 才会加入到队列中，当进行到下一次事件循环中，清空该队列即可。从而保证同一个事件循环中，多次更改数据只进行一次视图更新操作。

#### 实现原理

watcher

flashQueue

#### 延迟 DOM 更新后执行

#### 多次调用只会向队列中添加一个任务

变量 pending

#### 优雅降级

2.4 和 2.4 之后的版本

原型上的\$nextTick 只是调用了 nextTick 方法

- [ ] Vue.nextTick 不会，此时回调函数中的 this 指向谁？

- [ ] 和 watcher 更新的关系
